version: '3.8'

services:
  # ============================================
  # 方式一：使用 SQLite (默认，单机部署)
  # ============================================
  monitor:
    # 使用本地构建或从 GitHub Container Registry 拉取
    image: ghcr.io/prehisle/relay-pulse:latest
    # 如需本地构建,取消注释以下两行:
    # build:
    #   context: .

    container_name: relaypulse-monitor

    # 端口映射
    ports:
      - "8080:8080"

    # 挂载配置文件和数据目录
    volumes:
      - ./config.production.yaml:/config/config.yaml:ro
      # SQLite 持久化（使用 SQLite 时必须）:
      - ./monitor:/app/monitor-data

    # 环境变量覆盖 API 密钥 (推荐)
    environment:
      # 时区设置
      - TZ=Asia/Shanghai

      # 存储类型（默认 sqlite）
      # - MONITOR_STORAGE_TYPE=sqlite

      # API 密钥覆盖示例 (格式: MONITOR_<PROVIDER>_<SERVICE>_API_KEY)
      # - MONITOR_88CODE_CC_API_KEY=sk-your-real-key
      # - MONITOR_88CODE_CX_API_KEY=sk-another-key
      # - MONITOR_DUCKCODING_CC_API_KEY=sk-duck-key

    # 从 .env 文件加载环境变量 (推荐用于生产环境)
    # 使用方式: docker compose --env-file deploy/relaypulse.env up -d
    # env_file:
    #   - deploy/relaypulse.env

    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # 重启策略
    restart: unless-stopped

    # 资源限制 (可选)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.5'
    #       memory: 256M

  # ============================================
  # 方式二：使用 PostgreSQL (K8s/多副本部署推荐)
  # ============================================
  # 取消注释以下配置以启用 PostgreSQL 模式

  # postgres:
  #   image: postgres:16-alpine
  #   container_name: relaypulse-postgres
  #   environment:
  #     POSTGRES_USER: monitor
  #     POSTGRES_PASSWORD: monitor_password
  #     POSTGRES_DB: llm_monitor
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U monitor"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped

  # monitor-pg:
  #   image: ghcr.io/prehisle/relay-pulse:latest
  #   container_name: relaypulse-monitor-pg
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   ports:
  #     - "8080:8080"
  #   volumes:
  #     - ./config.production.yaml:/config/config.yaml:ro
  #   environment:
  #     - TZ=Asia/Shanghai
  #     - MONITOR_STORAGE_TYPE=postgres
  #     - MONITOR_POSTGRES_HOST=postgres
  #     - MONITOR_POSTGRES_PORT=5432
  #     - MONITOR_POSTGRES_USER=monitor
  #     - MONITOR_POSTGRES_PASSWORD=monitor_password
  #     - MONITOR_POSTGRES_DATABASE=llm_monitor
  #     - MONITOR_POSTGRES_SSLMODE=disable  # ⚠️ 仅限本地测试！生产环境必须使用 require
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 15s
  #   restart: unless-stopped

# volumes:
#   postgres_data:

# ============================================
# 使用说明
# ============================================
#
# ⚠️ 重要：生产部署必须使用环境变量文件加载 API Key！
#
# 方式一：SQLite 模式（默认，单机部署）
# ------------------------------
# 1. 准备环境变量:
#    cp deploy/relaypulse.env.example deploy/relaypulse.env
#    # 编辑 deploy/relaypulse.env，填入真实 API Key
#
# 2. 启动服务:
#    docker compose --env-file deploy/relaypulse.env up -d monitor
#
# 3. 查看日志:
#    docker compose logs -f monitor
#
# 4. 停止服务:
#    docker compose down
#
# 方式二：PostgreSQL 模式（K8s/多副本推荐）
# ------------------------------
# 1. 编辑 docker-compose.yaml，取消注释 postgres 和 monitor-pg 相关配置
#
# 2. 在 deploy/relaypulse.env 中设置 PostgreSQL 连接信息:
#    MONITOR_STORAGE_TYPE=postgres
#    MONITOR_POSTGRES_HOST=postgres
#    MONITOR_POSTGRES_PASSWORD=your_secure_password
#    MONITOR_POSTGRES_SSLMODE=require  # ⚠️ 生产环境必须启用 SSL
#
# 3. 启动服务（包含 PostgreSQL）:
#    docker compose --env-file deploy/relaypulse.env up -d postgres monitor-pg
#
# 4. 查看日志:
#    docker compose logs -f monitor-pg
#
# 5. 停止服务:
#    docker compose down
#    docker compose down -v  # 同时删除数据卷
#
# 开发模式（允许 localhost CORS）
# ------------------------------
# 在 deploy/relaypulse.env 中添加:
# MONITOR_CORS_ORIGINS=http://localhost:5173,http://localhost:3000
# ============================================
